# VoiceOps

[![Go Report Card](https://goreportcard.com/badge/github.com/rehydrate1/VoiceOps)](https://goreportcard.com/report/github.com/rehydrate1/VoiceOps)
[![Build Status](https://github.com/rehydrate1/voiceops/actions/workflows/go.yml/badge.svg)](https://github.com/rehydrate1/voiceops/actions)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**VoiceOps** — это система голосового управления инфраструктурой и мониторинга, разработанная специально для умных устройств **SberDevices** (SberBoom, ассистент Салют).

Проект служит мостом между экосистемой умного дома и IT-инфраструктурой, позволяя проверять статус сервисов, выполнять команды на удаленных серверах через SSH и управлять локальным оборудованием (Wake-on-LAN) с помощью естественной речи.

Приложение оптимизировано для работы на **Raspberry Pi** в качестве домашнего сервера.

## Возможности

*   **Мониторинг инфраструктуры:** Проверка доступности списка URL и голосовой отчет о статусе ("Проверь прод", "Запусти диагностику").
*   **Удаленное выполнение (SSH):** Выполнение произвольных консольных команд на внешних VPS по голосовым триггерам (например, `docker restart`).
*   **Wake-on-LAN (WoL):** Включение домашних ПК и серверов через Magic Packets. Работает нативно благодаря развертыванию в локальной сети.
*   **Интеграция с Салютом:** Поддержка SmartApp API (протокол Webhook).
*   **Гибкая конфигурация:** Все команды, URL и устройства описываются в едином YAML-файле.

## Технологический стек

-   **Язык:** Go 1.22+
-   **Веб-фреймворк:** [Gin](https://github.com/gin-gonic/gin)
-   **Automation:** Makefile (Cross-compilation & Deploy)
-   **SSH Клиент:** `golang.org/x/crypto/ssh`
-   **Конфигурация:** `gopkg.in/yaml.v3`
-   **CI/CD:** GitHub Actions

## Архитектура

Проект решает проблему безопасного доступа облачного ассистента в закрытую локальную сеть без открытия портов наружу.

**Поток данных:**
1.  **Пользователь** активирует навык: *"Салют, запусти VoiceOps"*.
2.  **Облако Сбера** открывает сессию и передает управление вебхуку.
3.  **Пользователь** дает команду: *"Проверь статус сервера"* или *"Включи мой ПК"*.
4.  **Туннелирование:** Запрос проходит через Reverse Proxy (Nginx на VPS) и попадает в локальную сеть через **SSH Reverse Tunnel**.
5.  **Ядро VoiceOps (Raspberry Pi):**
    *   Парсит интент пользователя.
    *   Выполняет бизнес-логику (HTTP-запрос / SSH-сессия во внешний мир / UDP-пакет в локальную сеть).
    *   Формирует ответ.
6.  **Колонка** озвучивает результат.

## Структура проекта

Проект следует принципам Clean Architecture и Standard Go Layout:

```text
.
├── cmd/               # Точка входа в приложение
│   └── main.go        # Сборка зависимостей
├── configs/           # Конфигурация приложения
│   └── config.yaml
├── internal/
│   ├── config/        # Логика загрузки конфигов
│   ├── handler/       # HTTP хендлеры (SmartApp API)
│   ├── models/        # Структуры данных
│   └── service/       # Бизнес-логика (SSH, Monitoring, WoL)
├── Makefile           # Скрипты сборки и деплоя
└── go.mod
```

## Конфигурация

Управление логикой происходит через файл `configs/config.yaml` без необходимости пересобирать приложение. Файл позволяет гибко настраивать все ключевые функции:

*   **`monitoring.urls`**: Вы можете добавлять в этот список любые URL-адреса для проверки их доступности.
*   **`commands`**: Вы можете создавать неограниченное количество собственных голосовых команд.
    *   `phrase`: Фраза, на которую будет реагировать ассистент.
    *   `script`: Команда, которая выполнится на удаленном сервере по SSH.
    *   `response`: Текст, который озвучит колонка. Поддерживается шаблон `%s` для подстановки результата выполнения команды (например, для `uptime`).
*   **`wol.devices`**: Добавляйте сюда устройства из вашей локальной сети, чтобы иметь возможность включать их голосом.

### Пример:

```yaml
ssh:
  host: "185.200.x.x:22"
  user: "root"
  key_path: "/home/pi/.ssh/id_rsa"

monitoring:
  urls:
    - "https://google.com"
    - "https://my-service.com"

commands:
  - phrase: "перезагрузи бота"
    script: "docker restart my-bot"
    response: "Готово. Бот перезагружен."
   
  - phrase: "статус сервера"
    script: "uptime"
    response: "Сервер в порядке. Аптайм: %s"

wol:
  enabled: true
  devices:
    - name: "мой пк"
      mac: "AA:BB:CC:DD:EE:FF"
      broadcast_ip: "255.255.255.255:9"
 ```

**⚠️ Важное замечание по Wake-on-LAN:**

Для корректной работы функции Wake-on-LAN необходимо предварительно настроить целевой компьютер:

1.  **Включить в BIOS/UEFI:** Найдите и активируйте опции `Wake on LAN`, `Power on by PCI/PCI-E` или аналогичные.
2.  **Отключить энергосбережение:** Убедитесь, что опция `ErP Ready` или `EuP` **отключена**, иначе сетевая карта будет полностью обесточена.
3.  **Настроить ОС:** В свойствах сетевого адаптера (в Windows) **может понадобиться** разрешить пробуждение "магическим пакетом" и отключить функцию "Быстрый запуск".
4.  **Проверить физически:** После выключения ПК светодиод на сетевом порту (LAN) должен продолжать мигать или гореть. Если он погас — питание на карту не подается.

## Развертывание

Проект включает автоматизацию для деплоя на Raspberry Pi (или любой Linux-сервер) одной командой.

### 1. Настройка окружения
Подготовьте файл `.env` с переменными для деплоя, скопировав пример:

```bash
cp .env.example .env
```

Затем отредактируйте `.env` и укажите ваши реальные данные:

```ini
PI_HOST=192.168.1.X
PI_USER=pi
PI_DIR=/home/pi/voiceops
PI_KEY=C:/Users/User/.ssh/id_rsa
```

### 2. Деплой
Используйте `make` для кросс-компиляции под ARM64, копирования на сервер и перезапуска systemd-сервиса:

```bash
make deploy
```

### 3. Локальный запуск (Разработка)
Для тестов на локальной машине:
```bash
go mod tidy
go run cmd/main.go
```

## Планы по развитию

-   [ ] **Метрики:** Интеграция с Prometheus & Grafana для мониторинга.
-   [ ] **Docker:** Упаковка в контейнер для удобного обновления (Watchtower).
-   [ ] **История:** Подключение SQLite для журнала команд.

## Лицензия

Проект распространяется под лицензией MIT.
